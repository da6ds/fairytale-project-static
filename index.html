<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>童话项目 | Fairytale Project | Fairytale-Projekt</title>
    <style>
        /* ========================================
           CSS RESET
           ======================================== */
        html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,
        img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,
        caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,menu,nav,output,
        ruby,section,summary,time,mark,audio,video {
            margin: 0;
            padding: 0;
            border: 0;
            font-size: 100%;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            font: inherit;
            vertical-align: baseline;
            font-family: Helvetica, Arial, Verdana, sans-serif;
            color: black;
        }

        img {
            border: 0;
            -ms-interpolation-mode: bicubic;
        }

        article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section {
            display: block;
        }

        body {
            line-height: 1;
            font-size: 62.5%;
        }

        ol,ul {
            list-style: none;
        }

        blockquote,q {
            quotes: none;
        }

        blockquote:before,blockquote:after,q:before,q:after {
            content: '';
            content: none;
        }

        table {
            border-collapse: collapse;
            border-spacing: 0;
        }

        /* ========================================
           BASE STYLES
           ======================================== */
        html {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
        }

        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            border: 0;
            background: #fff;
            font-size: 12px;
            line-height: 16px;
        }

        img {
            border: none;
        }

        form {
            margin-top: 5px;
            margin-bottom: 6px;
        }

        a {
            text-decoration: none;
            color: #000;
            font-weight: bold;
        }

        a:hover {
            color: red;
        }

        h2 {
            font-size: 20px;
            font-weight: 700;
            margin: 5px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #000;
            display: block;
            margin-bottom: 10px;
        }

        i {
            font-style: italic;
        }

        b {
            font-weight: 700;
        }

        #container {
            width: 100%;
            height: auto;
            border: 0;
            padding: 0;
            margin: 0;
        }

        /* ========================================
           NAVIGATION BOX (DRAGGABLE)
           ======================================== */
        #headercontainer {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 250px;
            z-index: 1000;
            margin: 0;
            padding: 0;
            cursor: move;
            user-select: none;
        }

        #headercontainer.dragging {
            cursor: grabbing;
        }

        #navbox {
            font-size: 11px;
            position: relative;
            width: 270px;
            background: #fff;
            padding: 5px 10px 10px;
            border: #000 2px solid;
            z-index: 1000;
        }

        #navbox h3 {
            font-weight: 700;
            font-size: 12px;
            line-height: 8px;
            margin-bottom: 0;
        }

        #navbox a {
            font-weight: normal;
        }

        #header {
            width: 270px;
            height: 145px;
            background-image: url('fairytale_header.png');
            background-position: center top;
            background-repeat: no-repeat;
            border-bottom: #000 1px dashed;
            margin-top: 5px;
        }

        #header h1 {
            visibility: hidden;
            color: #ed1c24;
            font-size: 25px;
        }

        #view {
            padding: 8px 0 14px 0;
            font-weight: 700;
            border-bottom: #000 1px dashed;
            margin-bottom: 5px;
            width: 100%;
        }

        #view select,
        #view .filter {
            font-weight: normal;
            border: 1px solid #000;
        }

        #filters {
            padding: 8px 0;
            border-bottom: #000 1px dashed;
            width: 100%;
            font-size: 11px;
        }

        .filter {
            width: 100%;
            margin-top: 10px;
        }

        #language {
            margin-top: 10px;
        }

        #gender {
            margin-top: 11px;
        }

        #region {
            margin-top: 11px;
        }

        #generation {
            margin-top: 11px;
        }

        #themes {
            margin-top: 11px;
        }

        .header_links {
            width: 100%;
            margin-top: 8px;
            font-size: 11px;
        }

        .header_links a {
            display: block;
            margin-bottom: 0;
        }

        #filters > p {
            margin-top: 6px;
        }

        #social {
            margin: 0;
            padding: 0;
            text-align: center;
        }

        #social a {
            background-image: url('Fairytale_Social.png');
            text-indent: -6000px;
            display: inline-block;
            height: 35px;
            width: 35px;
            margin: 0;
            padding: 0 2px;
        }

        #social a.facebook {
            background-position: 0px 0px;
        }

        #social a.twitter {
            background-position: -43px 0px;
        }

        #social a.googleplus {
            background-position: -86px 0px;
        }

        #social a.tumblr {
            background-position: -129px 0px;
        }

        #social a.renren {
            background-position: -172px 0px;
        }

        #social a.weibo {
            background-position: -215px 0px;
        }

        /* ========================================
           ZOOM CONTROLS (ATTACHED TO NAV BOX)
           ======================================== */
        #zoom-controls {
            position: absolute;
            bottom: -71px;
            left: -2px;
            display: flex;
            flex-direction: column;
            gap: 0px;
        }

      .zoom-btn {
            width: 29px;
            height: 27px;
            border: 2px solid #000;
            background: white;
            font-size: 27px;
            font-weight: 700;
            cursor: pointer;
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: background-color 0.2s;
            font-family: Helvetica, Arial, Verdana, sans-serif;
        }

        #zoom-in {
            border-bottom: none;
        }

        .zoom-btn:hover {
            background-color: #f0f0f0;
        }

        .zoom-btn:active {
            background-color: #e0e0e0;
        }

        .zoom-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* ========================================
           PARTICIPANT GRID
           ======================================== */
        #participants {
            position: relative;
            left: 0;
            right: 0;
            top: 0;
            height: auto;
            margin-top: 3px;
            padding: 0;
            text-align: center;
        }

        /* Zoom level classes - control .outer width */
        .zoom-level-0 .outer { width: 2.7%; }   /* 36 per row */
        .zoom-level-1 .outer { width: 3.4%; }   /* 29 per row */
        .zoom-level-2 .outer { width: 4.1%; }   /* 24 per row */
        .zoom-level-3 .outer { width: 4.9%; }   /* 20 per row */
        .zoom-level-4 .outer { width: 6.1%; }   /* 16 per row */
        .zoom-level-5 .outer { width: 7.3%; }   /* 13 per row - DEFAULT */
        .zoom-level-6 .outer { width: 9.8%; }   /* 10 per row */
        .zoom-level-7 .outer { width: 12.3%; }  /* 8 per row */

        .outer {
            display: inline-block;
            position: relative;
            /* width: 7.3%; */
            text-align: center;
            padding: 0.05% 0.18% 0.02%;
            height: auto;
            vertical-align: top;
            min-width: 45px;
            cursor:pointer;
        }

        .outer img {
            position: relative;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
            opacity: 0.4;
            transition: opacity 0.3s ease;
        }

        .outer:hover img {
            opacity: 1;
        }

        .outer p {
            font-size: 14px;
            padding-top: 40%;
        }

        .id {
            position: absolute;
            top: 0;
            width: 100%;
            height: 100%;
            text-align: center;
            opacity: 1;
            font-weight: 700;
            color: #4d4d4d;
            z-index: 0;
        }

        .outer:hover .id {
            color: white;
            text-shadow: 0 0 4px rgba(0,0,0,0.8), 0 0 8px rgba(0,0,0,0.6);
        }

        .active {
            opacity: 1;
        }

        .inactive {
            opacity: 0.4;
        }

        .inactive:hover {
            opacity: 1;
        }

        .participant-photo {
            cursor: pointer;
        }

        /* ========================================
           MAP VIEW
           ======================================== */
        #map-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            background: #fff;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Leaflet popup styling to match original */
        .leaflet-popup-content-wrapper {
            padding: 0;
            border-radius: 0;
        }

        .leaflet-popup-content {
            margin: 0;
            width: auto !important;
        }

        .map-popup-photo {
            width: 150px;
            height: auto;
            display: block;
            cursor: pointer;
        }

        .map-popup-photo:hover {
            opacity: 0.8;
        }

        /* ========================================
           STATS BAR
           ======================================== */
        .stats {
            position: fixed;
            bottom: 0;
            background: rgba(255, 255, 255, 0.71);
            display: block;
            width: 100%;
            padding: 3px;
            text-align: center;
            font-size: 11px;
        }

        /* ========================================
           MODAL
           ======================================== */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border: 3px solid #000;
            width: 80%;
            max-width: 700px;
            position: relative;
        }

        .close {
            color: #000;
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: red;
        }

        .modal-body {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .modal-photo {
            width: 300px;
            height: auto;
        }

        .modal-info {
            flex: 1;
        }

        .modal-info h2 {
            margin-top: 0;
            color: #c41e3a;
        }

        .modal-info p {
            margin: 10px 0;
        }
    </style>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

</head>
</head>
<body>
    <div id="container">
        <!-- Navigation Box -->
        <div id="headercontainer">
            <div id="navbox">
                <div id="header">
                    <h1>童话项目 / Fairytale Project / Fairytale-Projekt</h1>
                </div>

                <div id="view">
                    <h3>1. 选择视图 / Select View / Ansicht auswählen:<br /></h3>
                    <select id="viewSelect" class="filter">
                        <option value="grid">肖像 / Grid / Raster</option>
                        <option value="map">地图 / Map / Karte</option>
                    </select>
                </div>

                <div id="filters">
                    <h3>2. 选择过滤器 / Select Filters / Filter auswählen:<br /></h3>

                    <select id="language" class="filter">
                        <option value="">语言 / Languages / Sprachen</option>
                        <option value="Chinese">中文</option>
                        <option value="English">English</option>
                        <option value="German">Deutsch</option>
                    </select>

                    <select id="gender" class="filter">
                        <option value="">性别 / Gender / Geschlecht</option>
                        <option value="Male">男 / Male / Männlich</option>
                        <option value="Female">女 / Female / Weiblich</option>
                    </select>

                    <select id="region" class="filter">
                        <option value="">地区 / Region / Region</option>
                        <option value="East Asia">East Asia</option>
                        <option value="North America">North America</option>
                        <option value="Europe">Europe</option>
                        <option value="Southeast Asia">Southeast Asia</option>
                    </select>

                    <select id="generation" class="filter">
                        <option value="">出生年代 / Generation / Generation</option>
                        <option value="2000s">2000-2009</option>
                        <option value="1990s">1990-1999</option>
                        <option value="1980s">1980-1989</option>
                        <option value="1970s">1970-1979</option>
                        <option value="1960s">1960-1969</option>
                        <option value="1950s">1950-1959</option>
                    </select>

                    <select id="themes" class="filter">
                        <option value="">主题 / Themes / Themen</option>
                        <option value="Family">Family</option>
                        <option value="Migration">Migration</option>
                        <option value="Love">Love</option>
                        <option value="Dreams">Dreams</option>
                    </select>

                    <p><a href="#" id="resetFilters">重设过滤器 / Reset Filters / Filter zurücksetzen</a></p>
                </div>

                <div class="header_links">
                    <a href="#">项目简介 / Project Overview / Projekt-Überblick</a>
                    <a href="#">博客 / Blog / Blog</a>
                    <a href="#">参与者召唤 / Call to Participants / An die Teilnehmenden</a>
                    <div id="social">
                        <a href="http://www.facebook.com/sharer/sharer.php?u=http://www.fairytaleproject.net" target="_blank" class="facebook">Facebook</a>
                        <a href="http://clicktotweet.com/0RVj3" target="_blank" class="twitter">Twitter</a>
                        <a href="https://plusone.google.com/_/+1/confirm?hl=en&url=http://www.fairytaleproject.net" target="_blank" class="googleplus">Google Plus</a>
                        <a href="http://www.tumblr.com/share/link?url=http://www.fairytaleproject.net&name=The%20Fairytale%20Project" target="_blank" class="tumblr">Tumblr</a>
                        <a href="http://share.renren.com/share/buttonshare.do?link=http://www.fairytaleproject.net&title=The%20Fairytale%20Project" target="_blank" class="renren">RenRen</a>
                        <a href="http://service.weibo.com/share/share.php?url=http://www.fairytaleproject.net&appkey=&title=The%20Fairytale%20Project&pic=&ralateUid=&language=zh_cn" class="weibo" target="_blank">Weibo</a>
                    </div>
                </div>
                 <!-- Zoom Controls -->
                <div id="zoom-controls">
                    <button id="zoom-in" class="zoom-btn" title="Zoom In">&#43;</button>
                    <button id="zoom-out" class="zoom-btn" title="Zoom Out">&#8722;</button>
                </div>
            </div>
        </div>

        <!-- Participant Grid -->
        <div id="participants" class="zoom-level-5"></div>

        <!-- Map View -->
        <div id="map-container" style="display: none;">
            <div id="map"></div>
        </div>

        <!-- Stats Bar -->
        <div class="stats">
            <span id="visibleCount">0</span> of <span id="totalCount">0</span> participants visible
        </div>
    </div>

    <!-- Participant Detail Modal -->
    <div id="participantModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-body">
                <img id="modalPhoto" src="" alt="" class="modal-photo">
                <div class="modal-info">
                    <h2 id="modalId"></h2>
                    <p><strong>Gender:</strong> <span id="modalGender"></span></p>
                    <p><strong>Year:</strong> <span id="modalYear"></span></p>
                    <p><strong>Generation:</strong> <span id="modalGeneration"></span></p>
                    <p><strong>Region:</strong> <span id="modalRegion"></span></p>
                    <p><strong>Themes:</strong> <span id="modalThemes"></span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let participants = [];

        // ==========================================
        // ZOOM FUNCTIONALITY
        // ==========================================
        const ZOOM_LEVELS = [36, 29, 24, 20, 16, 13, 10, 8];
        const DEFAULT_ZOOM = 5; // Index for 13 per row (100%)
        let currentZoom = DEFAULT_ZOOM;

        function initZoom() {
            setZoomLevel(DEFAULT_ZOOM);
            
            document.getElementById('zoom-in').addEventListener('click', () => {
                if (currentZoom < ZOOM_LEVELS.length - 1) {
                    setZoomLevel(currentZoom + 1);
                }
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                if (currentZoom > 0) {
                    setZoomLevel(currentZoom - 1);
                }
            });
            
            updateZoomButtons();
        }

        function setZoomLevel(level) {
            const container = document.getElementById('participants');
            
            // Remove all zoom classes
            for (let i = 0; i < ZOOM_LEVELS.length; i++) {
                container.classList.remove(`zoom-level-${i}`);
            }
            
            // Add new zoom class
            container.classList.add(`zoom-level-${level}`);
            currentZoom = level;
            
            updateZoomButtons();
        }

        function updateZoomButtons() {
            const zoomIn = document.getElementById('zoom-in');
            const zoomOut = document.getElementById('zoom-out');
            
            zoomIn.disabled = (currentZoom === ZOOM_LEVELS.length - 1);
            zoomOut.disabled = (currentZoom === 0);
        }

        // ==========================================
        // DRAGGABLE NAV BOX
        // ==========================================
        function initDraggableNav() {
            const navContainer = document.getElementById('headercontainer');
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 20;
            let yOffset = 20;

            navContainer.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            function dragStart(e) {
                // Don't drag if clicking on links, buttons, or selects
                if (e.target.tagName === 'A' || e.target.tagName === 'SELECT' || e.target.tagName === 'BUTTON') {
                    return;
                }

                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === navContainer || navContainer.contains(e.target)) {
                    isDragging = true;
                    navContainer.classList.add('dragging');
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    setTranslate(currentX, currentY, navContainer);
                }
            }

            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;

                isDragging = false;
                navContainer.classList.remove('dragging');
            }

            function setTranslate(xPos, yPos, el) {
                el.style.left = `${xPos}px`;
                el.style.top = `${yPos}px`;
            }
        }

        // Load participants from JSON file
        fetch('fairytale-data.json')
            .then(response => response.json())
            .then(data => {
                participants = data;
                renderParticipants();
                setupModalHandlers();
                initZoom();  
                initDraggableNav();
                setupEventListeners();
            })
            .catch(error => {
                console.error('Error loading participant data:', error);
            });

        function renderParticipants() {
            const grid = document.getElementById('participants');
            grid.innerHTML = participants.map(p => `<div class="outer active" data-id="${p.id}" data-gender="${p.gender}" data-generation="${p.generation}" data-region="${p.region}" data-language="${p.language.join(',')}" data-themes="${p.themes.join(',')}">${p.photo ? `<img src="images/${p.photo}" alt="Participant ${p.id}" class="participant-photo">` : `<div class="no-photo">${p.id}</div>`}<p class="id">${p.id}</p></div>`).join('');
            updateStats();
        }

        function setupModalHandlers() {
            const modal = document.getElementById('participantModal');
            const closeBtn = document.querySelector('.close');
            const grid = document.getElementById('participants');

            // Click on photos to open modal
            grid.addEventListener('click', function(e) {
                if (e.target.classList.contains('participant-photo') || 
                    e.target.classList.contains('id') || 
                    e.target.classList.contains('outer')) {
                    const card = e.target.closest('.outer');
                    if (card) {
                        const participantId = card.dataset.id;
                        const participant = participants.find(p => p.id === participantId);
                        if (participant) {
                            showModal(participant);
                        }
                    }
                }
            });

            // Close button
            closeBtn.onclick = function() {
                modal.style.display = 'none';
            }

            // Click outside modal to close
            window.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        }

        function showModal(participant) {
            const modal = document.getElementById('participantModal');
            document.getElementById('modalPhoto').src = participant.photo ? `images/${participant.photo}` : '';
            document.getElementById('modalPhoto').alt = `Participant ${participant.id}`;
            document.getElementById('modalId').textContent = `Participant ${participant.id}`;
            document.getElementById('modalGender').textContent = participant.gender;
            document.getElementById('modalYear').textContent = participant.year;
            document.getElementById('modalGeneration').textContent = participant.generation;
            document.getElementById('modalRegion').textContent = participant.region;
            document.getElementById('modalThemes').textContent = participant.themes.join(', ');
            modal.style.display = 'block';
        }

        function filterParticipants() {
            const genderFilter = document.getElementById('gender').value;
            const regionFilter = document.getElementById('region').value;
            const generationFilter = document.getElementById('generation').value;
            const languageFilter = document.getElementById('language').value;
            const themesFilter = document.getElementById('themes').value;

            const cards = document.querySelectorAll('.outer');

            cards.forEach(card => {
                const gender = card.dataset.gender;
                const region = card.dataset.region;
                const generation = card.dataset.generation;
                const languages = card.dataset.language.split(',');
                const themes = card.dataset.themes.split(',');

                const matchesGender = !genderFilter || gender === genderFilter;
                const matchesRegion = !regionFilter || region === regionFilter;
                const matchesGeneration = !generationFilter || generation === generationFilter;
                const matchesLanguage = !languageFilter || languages.includes(languageFilter);
                const matchesThemes = !themesFilter || themes.includes(themesFilter);

                if (matchesGender && matchesRegion && matchesGeneration && matchesLanguage && matchesThemes) {
                    card.classList.remove('inactive');
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                    card.classList.add('inactive');
                }
            });

            updateStats();

        // Update map if visible
            if (map && document.getElementById('map-container').style.display === 'block') {
                updateMapMarkers();
            }
        }

        function updateStats() {
            const total = document.querySelectorAll('.outer').length;
            const visible = document.querySelectorAll('.outer.active').length;
            document.getElementById('totalCount').textContent = total;
            document.getElementById('visibleCount').textContent = visible;
        }

        function resetFilters() {
            document.getElementById('gender').value = '';
            document.getElementById('region').value = '';
            document.getElementById('generation').value = '';
            document.getElementById('language').value = '';
            document.getElementById('themes').value = '';
            filterParticipants();
        }

        function setupEventListeners() {
            // View selector
            document.getElementById('viewSelect').addEventListener('change', function(e) {
                if (e.target.value === 'map') {
                    showMapView();
                } else {
                    showGridView();
                }
            });
    
            // Filter dropdowns
            document.getElementById('language').addEventListener('change', filterParticipants);
            document.getElementById('gender').addEventListener('change', filterParticipants);
            document.getElementById('region').addEventListener('change', filterParticipants);
            document.getElementById('generation').addEventListener('change', filterParticipants);
            document.getElementById('themes').addEventListener('change', filterParticipants);
    
            // Reset button
            document.getElementById('resetFilters').addEventListener('click', function(e) {
            e.preventDefault();
                resetFilters();
            });
        }

        // ==========================================
        // MAP FUNCTIONALITY
        // ==========================================
        let map = null;
        let markers = [];

        // Chinese provinces coordinates lookup
        const provinceCoordinates = {
            'Anhui': [31.8612, 117.2840],
            'Beijing': [39.9042, 116.4074],
            'Chongqing': [29.4316, 106.9123],
            'Fujian': [26.0745, 119.2965],
            'Gansu': [36.0611, 103.8343],
            'Guangdong': [23.1291, 113.2644],
            'Guangxi': [22.8170, 108.3665],
            'Guizhou': [26.5783, 106.7135],
            'Hainan': [20.0174, 110.3493],
            'Hebei': [38.0373, 114.4686],
            'Heilongjiang': [45.7570, 126.6420],
            'Henan': [34.7466, 113.6254],
            'Hong Kong': [22.3193, 114.1694],
            'Hubei': [30.5928, 114.3055],
            'Hunan': [28.1987, 112.9830],
            'Inner Mongolia': [40.8174, 111.7656],
            'Jiangsu': [32.0603, 118.7969],
            'Jiangxi': [28.6764, 115.8923],
            'Jilin': [43.8378, 125.3245],
            'Liaoning': [41.8057, 123.4328],
            'Ningxia': [38.4681, 106.2588],
            'Qinghai': [36.6171, 101.7782],
            'Shaanxi': [34.2658, 108.9541],
            'Shandong': [36.6758, 117.0006],
            'Shanghai': [31.2304, 121.4737],
            'Shanxi': [37.8706, 112.5489],
            'Sichuan': [30.5728, 104.0668],
            'Tianjin': [39.3434, 117.3616],
            'Tibet': [29.6520, 91.1722],
            'Xinjiang': [43.7928, 87.6278],
            'Yunnan': [25.0406, 102.7103],
            'Zhejiang': [30.2875, 120.1534],
            'Macau': [22.1987, 113.5439]
        };

        function showMapView() {
            document.getElementById('participants').style.display = 'none';
            document.getElementById('map-container').style.display = 'block';
            
            if (!map) {
                initMap();
            }
            
            updateMapMarkers();
        }

        function showGridView() {
            document.getElementById('participants').style.display = 'block';
            document.getElementById('map-container').style.display = 'none';
        }

        function initMap() {
            map = L.map('map').setView([35.0, 105.0], 5);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
        }

        function updateMapMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            const activeCards = document.querySelectorAll('.outer.active');
            
            activeCards.forEach(card => {
                const participantId = card.dataset.id;
                const participant = participants.find(p => p.id === participantId);
                
                if (participant && participant.region && provinceCoordinates[participant.region]) {
                    const coords = provinceCoordinates[participant.region];
                    
                    const lat = coords[0] + (Math.random() - 0.5) * 0.5;
                    const lng = coords[1] + (Math.random() - 0.5) * 0.5;
                    
                    const marker = L.circleMarker([lat, lng], {
                        radius: 8,
                        fillColor: '#000',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 1
                    }).addTo(map);
                    
                    const popupContent = `
                        <img src="${participant.photo ? 'images/' + participant.photo : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2255%22 text-anchor=%22middle%22 font-size=%2220%22 fill=%22%23666%22%3E${participant.id}%3C/text%3E%3C/svg%3E'}" 
                             class="map-popup-photo" 
                             data-id="${participant.id}"
                             alt="Participant ${participant.id}">
                    `;
                    
                    marker.bindPopup(popupContent);
                    
                    marker.on('popupopen', function() {
                        const img = document.querySelector('.map-popup-photo');
                        if (img) {
                            img.addEventListener('click', function() {
                                const id = this.getAttribute('data-id');
                                const p = participants.find(x => x.id === id);
                                if (p) showModal(p);
                            });
                        }
                    });
                    
                    markers.push(marker);
                }
            });
        }

    </script>
</body>
</html>